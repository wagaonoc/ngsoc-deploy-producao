---
- name: Deploy mitmproxy container and export CA to nginx exports
  hosts: localhost
  connection: local
  gather_facts: yes
  become: yes

  vars:
    mitm_image: "mitmproxy/mitmproxy"
    mitm_container_name: "ngsoc_mitmproxy"
    mitm_proxy_port: 8089
    mitm_web_port: 8090

    # Estrutura padronizada do /opt/ngsoc-deploy
    mitm_data_dir: "/opt/ngsoc-deploy/data/mitmproxy"
    mitm_logs_dir: "/opt/ngsoc-deploy/logs/mitmproxy"
    mitm_certs_dir: "{{ mitm_data_dir }}/certs"
    mitm_exports_dir: "/opt/ngsoc-deploy/exports/mitmproxy"
    mitm_reports_dir: "/opt/ngsoc-deploy/reports/mitmproxy"
    mitm_docs_dir: "/opt/ngsoc-deploy/docs/mitmproxy"

    mitm_ui_pass: "zap"
    mitm_wait_timeout: 180
    mitm_wait_delay: 3

    nginx_export_port: 8085
    export_filename: "mitmproxy-ca-cert.pem"

  pre_tasks:
    - name: "Verificar se a collection community.docker est√° instalada"
      ansible.builtin.shell: |
        ansible-galaxy collection list community.docker | grep -q "community.docker" && echo "INSTALLED" || echo "NOT_FOUND"
      register: docker_collection_check
      changed_when: false
      failed_when: false

    - name: "Instalar collection community.docker se n√£o existir"
      ansible.builtin.command: ansible-galaxy collection install community.docker
      when: docker_collection_check.stdout.find('NOT_FOUND') != -1
      register: docker_collection_install
      changed_when: "'Installing' in docker_collection_install.stdout or 'installed successfully' in docker_collection_install.stdout"

  tasks:
    # ===============================================================
    # Diret√≥rios base
    # ===============================================================
    - name: Ensure base directories exist for mitmproxy
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0775'
      loop:
        - "{{ mitm_data_dir }}"
        - "{{ mitm_certs_dir }}"
        - "{{ mitm_logs_dir }}"
        - "{{ mitm_exports_dir }}"
        - "{{ mitm_reports_dir }}"
        - "{{ mitm_docs_dir }}"

    - name: Ensure logs directory is owned by container user (UID 1000)
      ansible.builtin.file:
        path: "{{ mitm_logs_dir }}"
        owner: 1000
        group: 1000
        mode: '0775'
        recurse: yes

    # ===============================================================
    # Gerenciamento de container
    # ===============================================================
    - name: Remove existing mitmproxy container if present
      community.docker.docker_container:
        name: "{{ mitm_container_name }}"
        state: absent
        force_kill: true
      ignore_errors: true

    - name: Pull mitmproxy image
      community.docker.docker_image:
        name: "{{ mitm_image }}"
        tag: "latest"
        source: pull

    - name: Run mitmproxy container using logs directory as mount
      community.docker.docker_container:
        name: "{{ mitm_container_name }}"
        image: "{{ mitm_image }}:latest"
        restart_policy: always
        environment:
          MITMPROXY_WEB_PASSWORD: "{{ mitm_ui_pass }}"
        published_ports:
          - "{{ mitm_proxy_port }}:{{ mitm_proxy_port }}"
          - "{{ mitm_web_port }}:{{ mitm_web_port }}"
        volumes:
          - "{{ mitm_logs_dir }}:/home/mitmproxy/.mitmproxy:rw"
        command:
          - "mitmweb"
          - "--listen-host"
          - "0.0.0.0"
          - "--listen-port"
          - "{{ mitm_proxy_port }}"
          - "--web-host"
          - "0.0.0.0"
          - "--web-port"
          - "{{ mitm_web_port }}"
          - "--set"
          - "web_password={{ mitm_ui_pass }}"
        state: started
        detach: true
        networks:
          - name: "ngsoc_net"


    - name: Wait until mitmproxy container is running
      ansible.builtin.shell: |
        docker inspect --format='{{"{{.State.Status}}"}}' {{ mitm_container_name }} 2>/dev/null || echo notfound
      register: cont_state
      until: cont_state.stdout.find('running') != -1
      retries: 30
      delay: 2
      failed_when: cont_state.stdout.find('running') == -1

    - name: Pause briefly for mitmproxy initialization
      ansible.builtin.pause:
        seconds: 4

    # ===============================================================
    # Gera√ß√£o e c√≥pia do certificado CA
    # ===============================================================
    - name: Force generation of mitmproxy CA certificate inside container
      ansible.builtin.shell: |
        set -e
        CONTAINER={{ mitm_container_name }}
        HOSTIP="{{ ansible_default_ipv4.address }}"
        docker exec $CONTAINER sh -c "(curl -s --max-time 3 http://mitm.it/ || wget -qO- --timeout=3 http://mitm.it/) >/dev/null 2>&1 || true"
        docker exec $CONTAINER sh -c "(curl -s --max-time 3 http://$HOSTIP:{{ mitm_web_port }}/ || true)" >/dev/null 2>&1 || true
      register: ca_force
      ignore_errors: true
      changed_when: false

    - name: Wait for mitmproxy CA to appear in logs dir
      ansible.builtin.wait_for:
        path: "{{ mitm_logs_dir }}/{{ export_filename }}"
        state: present
        timeout: "{{ mitm_wait_timeout }}"
      register: ca_wait
      ignore_errors: true

    - name: Copy CA certificate to exports directory (if found)
      ansible.builtin.copy:
        src: "{{ mitm_logs_dir }}/{{ export_filename }}"
        dest: "{{ mitm_exports_dir }}/{{ export_filename }}"
        owner: root
        group: root
        mode: '0644'
      when: ca_wait is succeeded

    - name: "Also copy CA to mitm data certs dir (for backup/config) - robust fallback"
      ansible.builtin.shell: |
        set -e
        SRC="{{ mitm_logs_dir }}/{{ export_filename }}"
        DST="{{ mitm_certs_dir }}/{{ export_filename }}"
        if [ -f "$SRC" ]; then
          mkdir -p "{{ mitm_certs_dir }}"
          cp -f "$SRC" "$DST"
          chown root:root "$DST" || true
          chmod 0644 "$DST" || true
          echo "COPIED_FROM_LOGS"
        elif [ -f "{{ mitm_certs_dir }}/{{ export_filename }}" ]; then
          echo "ALREADY_IN_CERTS"
        else
          # fallback: try docker cp from container (n√£o falha se container n√£o existir)
          docker cp {{ mitm_container_name }}:/home/mitmproxy/.mitmproxy/{{ export_filename }} "{{ mitm_certs_dir }}/{{ export_filename }}" 2>/dev/null || true
          if [ -f "{{ mitm_certs_dir }}/{{ export_filename }}" ]; then
            echo "COPIED_FROM_CONTAINER"
          else
            echo "NO_CERT_FOUND"
            exit 0
          fi
        fi
      register: mitm_copy_to_certs
      changed_when: "'COPIED_FROM_LOGS' in (mitm_copy_to_certs.stdout | default('')) or 'COPIED_FROM_CONTAINER' in (mitm_copy_to_certs.stdout | default(''))"
      failed_when: false


    # ===============================================================
    # Documenta√ß√£o
    # ===============================================================
    - name: Create README-testers in exports dir for testers
      ansible.builtin.copy:
        dest: "{{ mitm_exports_dir }}/README-testers.txt"
        content: |
          NG-SOC - MITMProxy Test Instructions
          ------------------------------------
          - CA file: {{ export_filename }}
          - Download URL:
            http://{{ ansible_default_ipv4.address }}:{{ nginx_export_port }}/{{ export_filename }}
          - Proxy host: {{ ansible_default_ipv4.address }}
          - Proxy port: {{ mitm_proxy_port }}
          - Mitmweb UI: http://{{ ansible_default_ipv4.address }}:{{ mitm_web_port }}/#/flows
        mode: '0644'

    - name: Create standardized README in /opt/ngsoc-deploy/docs/mitmproxy/README.txt
      ansible.builtin.copy:
        dest: "{{ mitm_docs_dir }}/README.txt"
        content: |
          ==========================================================
          NG-SOC - MITMProxy Usage & Access (ngsoc_mitmproxy)
          ==========================================================

          üåê ACESSO AO UI (Mitmweb):
          * URL: http://{{ ansible_default_ipv4.address }}:{{ mitm_web_port }}/#/flows

          üîß ACESSO AO PROXY:
          * Host: {{ ansible_default_ipv4.address }}
          * Porta: {{ mitm_proxy_port }}

          üìÅ DIRET√ìRIOS PERSISTENTES:
          * Data:    {{ mitm_data_dir }}
          * Certs:   {{ mitm_certs_dir }}
          * Logs:    {{ mitm_logs_dir }}
          * Exports: {{ mitm_exports_dir }}
          * Reports: {{ mitm_reports_dir }}
          * Docs:    {{ mitm_docs_dir }}

          üîê CERTIFICADO/CA:
          * Export p√∫blico: {{ mitm_exports_dir }}/{{ export_filename }}
          * Backup interno: {{ mitm_certs_dir }}/{{ export_filename }}

          üß© CONTAINER:
          * Nome: {{ mitm_container_name }}
          * Imagem: {{ mitm_image }}:latest
          * Rein√≠cio autom√°tico: always
          * Volume: {{ mitm_logs_dir }}:/home/mitmproxy/.mitmproxy

          üß∞ COMANDOS √öTEIS:
          * docker ps --filter "name={{ mitm_container_name }}"
          * tail -f {{ mitm_logs_dir }}/mitmproxy.log
          * docker cp {{ mitm_container_name }}:/home/mitmproxy/.mitmproxy/{{ export_filename }} {{ mitm_exports_dir }}/
        mode: '0644'
        owner: root
        group: root

    # ===============================================================
    # Valida√ß√£o e resumo final
    # ===============================================================
    - name: Check if nginx exports container (ngsoc_exports) is running
      ansible.builtin.shell: |
        docker ps --filter "name=ngsoc_exports" --format '{{"{{.Names}}:{{.Status}}"}}' || true
      register: nginx_running
      changed_when: false

    - name: Validate CA URL via localhost (only if ngsoc_exports is running)
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ nginx_export_port }}/{{ export_filename }}"
        method: GET
        status_code: 200
        return_content: false
      register: ca_url_check
      when: "'ngsoc_exports' in (nginx_running.stdout | default(''))"
      ignore_errors: true

    - name: Final summary (MITM)
      ansible.builtin.debug:
        msg: |
          ==========================================================
          MITMProxy DEPLOY SUMMARY
          ==========================================================
          Container: {{ mitm_container_name }}
          Web UI : http://{{ ansible_default_ipv4.address }}:{{ mitm_web_port }}/#/flows
          Proxy  : {{ ansible_default_ipv4.address }}:{{ mitm_proxy_port }}
          CA file (logs): {{ mitm_logs_dir }}/{{ export_filename }}
          CA copy (certs): {{ mitm_certs_dir }}/{{ export_filename }}
          CA exports: {{ mitm_exports_dir }}/{{ export_filename }}
          Nginx exports: {{ nginx_running.stdout | default('NOT RUNNING') }}
          ==========================================================
