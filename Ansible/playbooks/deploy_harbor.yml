#!/bin/bash
set -e

INSTALL_DIR="/opt/ngsoc-deploy/data/harbor/installer"

echo "=========================================================="
echo "üöÄ DEPLOY DO HARBOR"
echo "=========================================================="

# 1. Validar docker-compose existente
if [ ! -f "${INSTALL_DIR}/docker-compose.yml" ]; then
  echo "‚ùå Arquivo docker-compose.yml n√£o encontrado em ${INSTALL_DIR}"
  exit 1
fi

# 2. Subir containers
echo "üß± Iniciando containers..."
docker compose -f "${INSTALL_DIR}/docker-compose.yml" up -d

# 3. Aguardar inicializa√ß√£o
echo "‚è≥ Aguardando inicializa√ß√£o do Harbor..."
sleep 20

# 4. Verificar sa√∫de do jobservice
echo "üîç Verificando sa√∫de do jobservice..."
if docker compose -f "${INSTALL_DIR}/docker-compose.yml" ps | grep -q "harbor-jobservice"; then
  STATUS=$(docker compose -f "${INSTALL_DIR}/docker-compose.yml" ps | grep harbor-jobservice | awk '{print $6}')
  echo "üìä Status atual do jobservice: ${STATUS}"
else
  echo "‚ö†Ô∏è  Jobservice n√£o encontrado."
fi

# 5. Testar manualmente o endpoint interno
echo "üåê Testando endpoint interno de sa√∫de..."
docker exec harbor-jobservice curl -s http://localhost:8080/ > /dev/null 2>&1 && echo "‚úÖ Jobservice ativo e respondendo na porta 8080!" || echo "‚ùå Falha ao acessar o jobservice."

# 6. Resumo
echo "=========================================================="
echo "üéØ STATUS FINAL DO DEPLOY"
docker compose -f "${INSTALL_DIR}/docker-compose.yml" ps
echo "=========================================================="
