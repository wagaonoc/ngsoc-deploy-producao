---
- name: Deploy Harbor (v2.14.0) - NGSOC (modo limpo)
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    # ===== Vers√£o/identidade =====
    harbor_version: "v2.14.0"
    harbor_hostname: "harbor.local"
    harbor_http_port: 8081          # OK, sem conflito externo
    harbor_https_port: 8443
    harbor_admin_password: "Harbor12345"
    harbor_db_password: "HarborDBpass"

    # ===== Estrutura NGSOC =====
    ngsoc_root: "/opt/ngsoc-deploy"
    harbor_base_dir: "{{ ngsoc_root }}/data/harbor"
    harbor_installer_dir: "{{ harbor_base_dir }}/installer"
    harbor_compose_dir: "{{ harbor_installer_dir }}"
    harbor_data_dir: "{{ harbor_base_dir }}/data"
    harbor_logs_dir: "{{ ngsoc_root }}/logs/harbor"
    harbor_docs_dir: "{{ ngsoc_root }}/docs/harbor"

    # ===== Docker repo (Ubuntu 22.04) =====
    docker_release_codename: "jammy"

    # ===== Integra√ß√£o Trivy externo =====
    use_external_trivy: true
    external_trivy_network: "ngsoc_net"
    external_trivy_service_name: "trivy-server"   # garantir container com esse nome
    external_trivy_port: 4954

  tasks:
    # ---------------------
    # 0) Pr√©-requisitos
    # ---------------------
    - name: Pacotes base
      ansible.builtin.apt:
        name: [curl, ca-certificates, gnupg, tar, jq]
        update_cache: yes
        state: present

    # ---------------------
    # 1) Docker CE + Compose
    # ---------------------
    - name: Garantir /etc/apt/keyrings
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Instalar chave GPG Docker
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Adicionar repo Docker
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/docker.list
        mode: '0644'
        content: |
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ docker_release_codename }} stable

    - name: Atualizar cache apt
      ansible.builtin.apt:
        update_cache: yes

    - name: Instalar Docker e plugin Compose
      ansible.builtin.apt:
        name: [docker-ce, docker-ce-cli, containerd.io, docker-compose-plugin]
        state: present

    # ---------------------
    # 2) Estrutura NGSOC
    # ---------------------
    - name: Criar diret√≥rios NGSOC do Harbor
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ harbor_installer_dir }}"
        - "{{ harbor_data_dir }}"
        - "{{ harbor_logs_dir }}"
        - "{{ harbor_docs_dir }}"
        - "/etc/ssl/certs"
        - "/etc/ssl/private"

    - name: Gerar certificado autoassinado (se ausente)
      ansible.builtin.shell: |
        openssl req -newkey rsa:4096 -nodes -sha256 \
          -keyout /etc/ssl/private/nginx-selfsigned.key \
          -x509 -days 365 \
          -out /etc/ssl/certs/nginx-selfsigned.crt \
          -subj "/CN={{ harbor_hostname }}" \
          -addext "subjectAltName = DNS:{{ harbor_hostname }},IP:{{ ansible_default_ipv4.address }}"
      args:
        creates: /etc/ssl/certs/nginx-selfsigned.crt

    - name: Mapear harbor.local em /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ ansible_default_ipv4.address | default('127.0.0.1') }} {{ harbor_hostname }}"
        state: present
        insertafter: EOF

    # ---------------------
    # 3) Baixar installer oficial (sempre limpo)
    # ---------------------

    - name: Limpar conte√∫do antigo do installer (preserva diret√≥rio base)
      ansible.builtin.shell: |
        rm -rf {{ harbor_installer_dir }}/* || true
      changed_when: false


    - name: Recriar diret√≥rio do installer
      ansible.builtin.file:
        path: "{{ harbor_installer_dir }}"
        state: directory
        mode: '0755'

    - name: Baixar Harbor online installer
      ansible.builtin.get_url:
        url: "https://github.com/goharbor/harbor/releases/download/{{ harbor_version }}/harbor-online-installer-{{ harbor_version }}.tgz"
        dest: "/tmp/harbor-{{ harbor_version }}.tgz"
        mode: '0644'

    - name: Extrair installer
      ansible.builtin.unarchive:
        src: "/tmp/harbor-{{ harbor_version }}.tgz"
        dest: "{{ harbor_installer_dir }}"
        remote_src: yes
        extra_opts: ["--strip-components=1"]

    # ---------------------
    # 4) harbor.yml (com Trivy externo)
    # ---------------------
    - name: Escrever harbor.yml
      ansible.builtin.copy:
        dest: "{{ harbor_installer_dir }}/harbor.yml"
        mode: '0644'
        content: |
          hostname: {{ harbor_hostname }}
          http:
            port: {{ harbor_http_port }}
          https:
            port: {{ harbor_https_port }}
            certificate: /etc/ssl/certs/nginx-selfsigned.crt
            private_key: /etc/ssl/private/nginx-selfsigned.key
          harbor_admin_password: "{{ harbor_admin_password }}"
          data_volume: {{ harbor_data_dir }}
          log:
            level: info
            local:
              location: {{ harbor_logs_dir }}
            syslog:
              port: 0          # üîí N√ÉO usar 1514 (Wazuh)
              protocol: tcp
            external_endpoint: ""
          database:
            password: "{{ harbor_db_password }}"
          trivy:
            server_url: "http://{{ external_trivy_service_name }}:{{ external_trivy_port }}"
          jobservice:
            max_job_workers: 10
            logger_sweeper_duration: 1
            job_loggers:
              - name: "FILE"
                level: "INFO"
                settings:
                  base_dir: "/var/log/jobs"
                  rotate_count: 50
                  rotate_size: 200M
                  compress: true
          notification:
            webhook_job_max_retry: 3
            webhook_job_http_client_timeout: 30s

    # ---------------------
    # 5) LIMPEZA de containers e redes antigas
    # ---------------------
    - name: Remover containers Harbor antigos
      ansible.builtin.shell: |
        OLD_CONTAINERS=$(docker ps -a --format '{{ "{{.Names}}" }}' | grep -E '^harbor-|^registry$|^redis$' || true)
        if [ -n "$OLD_CONTAINERS" ]; then
          echo "$OLD_CONTAINERS" | while read -r c; do
            docker rm -f "$c" || true
          done
        fi
      changed_when: false

    - name: Remover redes Harbor antigas
      ansible.builtin.shell: |
        OLD_NETS=$(docker network ls --format '{{ "{{.Name}}" }}' | grep -E 'harbor' || true)
        if [ -n "$OLD_NETS" ]; then
          echo "$OLD_NETS" | while read -r n; do
            docker network rm "$n" || true
          done
        fi
      changed_when: false

    # ---------------------
    # 6) Gerar configs oficiais (prepare)
    # ---------------------
#    - name: Limpar diret√≥rio harbor gerado
#      ansible.builtin.file:
#        path: "{{ harbor_compose_dir }}"
#        state: absent

    - name: Executar prepare --with-trivy (verifica√ß√£o robusta)
      ansible.builtin.shell: |
        if [ ! -d "{{ harbor_installer_dir }}" ]; then
          echo "‚ùå Diret√≥rio {{ harbor_installer_dir }} n√£o existe!"
          exit 1
        fi
        ls -la {{ harbor_installer_dir }}
        ./prepare --with-trivy
      args:
        chdir: "{{ harbor_installer_dir }}"
      register: harbor_prepare_result
      changed_when: true

    # ---------------------
    # 6.0) P√≥s-prepare: Corre√ß√µes e diret√≥rios do Trivy Adapter
    # ---------------------
    - name: Criar diret√≥rios do Trivy Adapter
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0777'
      loop:
        - "{{ harbor_installer_dir }}/common/config/trivy-adapter"
        - "{{ harbor_installer_dir }}/common/config/trivy-adapter/env"
        - "{{ harbor_base_dir }}/trivy/reports"

    - name: Regravar arquivo env do Trivy Adapter
      ansible.builtin.copy:
        dest: "{{ harbor_installer_dir }}/common/config/trivy-adapter/env/env"
        mode: '0644'
        content: |
          SCANNER_LOG_LEVEL=info
          SCANNER_REDIS_URL=redis://redis:6379/5?idle_timeout_seconds=30
          SCANNER_STORE_REDIS_URL=redis://redis:6379/5?idle_timeout_seconds=30
          SCANNER_STORE_REDIS_NAMESPACE=harbor.scanner.trivy:store
          SCANNER_JOB_QUEUE_REDIS_URL=redis://redis:6379/5?idle_timeout_seconds=30
          SCANNER_JOB_QUEUE_REDIS_NAMESPACE=harbor.scanner.trivy:job-queue
          SCANNER_TRIVY_CACHE_DIR=/home/scanner/.cache/trivy
          SCANNER_TRIVY_REPORTS_DIR=/home/scanner/.cache/reports
          SCANNER_TRIVY_VULN_TYPE=os,library
          SCANNER_TRIVY_SEVERITY=UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          SCANNER_TRIVY_IGNORE_UNFIXED=False
          SCANNER_TRIVY_SKIP_UPDATE=False
          SCANNER_TRIVY_SKIP_JAVA_DB_UPDATE=False
          SCANNER_TRIVY_OFFLINE_SCAN=False
          SCANNER_TRIVY_SECURITY_CHECKS=vuln
          SCANNER_TRIVY_GITHUB_TOKEN=
          SCANNER_TRIVY_INSECURE=False
          SCANNER_TRIVY_TIMEOUT=5m0s
          HTTP_PROXY=
          HTTPS_PROXY=
          NO_PROXY=


    # ---------------------
    # 6.1) P√≥s-prepare: Remover binding da porta 1514 (evita conflito com Wazuh)
    # ---------------------
    - name: Remover binding de porta 1514 do docker-compose.yml (evita conflito com Wazuh)
      ansible.builtin.lineinfile:
        path: "{{ harbor_installer_dir }}/docker-compose.yml"
        regexp: '.*1514:10514.*'
        state: absent

    # ---------------------
    # 6.2) P√≥s-prepare: Garantir que o servi√ßo harbor-log n√£o exponha portas
    # ---------------------
    - name: Remover se√ß√£o 'ports' do servi√ßo harbor-log (limpeza preventiva)
      ansible.builtin.replace:
        path: "{{ harbor_installer_dir }}/docker-compose.yml"
        regexp: '^\s*ports:\n(\s*-\s*127\.0\.0\.1:1514:10514.*\n?)*'
        replace: ''
      register: log_patch_result
      changed_when: log_patch_result.changed


    # ---------------------
    # 6.3) P√≥s-prepare: Corre√ß√£o de bindings de porta incorretos (8081:8080 / 8443:8443)
    # ---------------------
    - name: Corrigir bindings de porta incorretos no docker-compose.yml
      ansible.builtin.shell: |
        echo "üîß Removendo bindings de porta incorretos (8081/8443)..."
        sed -i '/- 8081:8080/d' {{ harbor_installer_dir }}/docker-compose.yml
        sed -i '/- 8443:8443/d' {{ harbor_installer_dir }}/docker-compose.yml
        echo "‚úÖ Port bindings corrigidos."
      changed_when: true

    # ---------------------
    # 6.4) P√≥s-prepare: Valida√ß√£o do YAML do Harbor (garante sintaxe v√°lida)
    # ---------------------
    - name: Validar docker-compose.yml (sintaxe)
      ansible.builtin.shell: |
        docker compose -f {{ harbor_installer_dir }}/docker-compose.yml config >/dev/null 2>&1
      register: compose_validation
      changed_when: false
      failed_when: compose_validation.rc != 0
      ignore_errors: false
      tags: validate


    # ---------------------
    # 6.5) P√≥s-prepare: Regravar config.yml do Jobservice (modelo funcional est√°vel)
    # ---------------------
    - name: Regravar configura√ß√£o padr√£o do Jobservice
      ansible.builtin.copy:
        dest: /opt/ngsoc-deploy/data/harbor/installer/common/config/jobservice/config.yml
        content: |
          ---
          # Protocol used to serve
          protocol: "http"

          # Server listening port
          port: 8080

          # Worker pool
          worker_pool:
            # Worker concurrency
            workers: 10
            backend: "redis"
            # Additional config if use 'redis' backend
            redis_pool:
              # redis://[arbitrary_username:password@]ipaddress:port/database_index
              redis_url: redis://redis:6379/2?idle_timeout_seconds=30
              namespace: "harbor_job_service_namespace"
              idle_timeout_second: 3600

          # Loggers for the running job
          job_loggers:
            - name: "FILE"
              level: "INFO"
              settings:
                base_dir: "/var/log/jobs"
                rotate_count: 50
                rotate_size: 200M
                compress: true

          # Loggers for the job service
          loggers:
            - name: "STD_OUTPUT"
              level: "INFO"

          reaper:
            # The max time to wait for a task to finish, if unfinished after max_update_hours,
            # the task will be marked as error, but will continue to run.
            max_update_hours: 24
            # The max time for execution in running state without new task created
            max_dangling_hours: 168

          # The max size of job log returned by API, default is 10M
          max_retrieve_size_mb: 10
      notify: Reiniciar Harbor Jobservice


    # ---------------------
    # 6.7) P√≥s-prepare: Restaurar bloco 'ports' no PROXY (Permitir acesso externo)
    # ---------------------
    - name: Adicionar bloco 'ports:' no servi√ßo proxy (nginx)
      ansible.builtin.lineinfile:
        path: "{{ harbor_installer_dir }}/docker-compose.yml"
        insertafter: 'container_name: nginx'
        line: '    ports:'
        state: present
      notify: Reiniciar Harbor Proxy

    - name: Adicionar mapeamento HTTPS (8443)
      ansible.builtin.lineinfile:
        path: "{{ harbor_installer_dir }}/docker-compose.yml"
        insertafter: '    ports:'
        line: '      - "{{ harbor_https_port }}:8443"'
        state: present
      notify: Reiniciar Harbor Proxy

    - name: Adicionar mapeamento HTTP (8081)
      ansible.builtin.lineinfile:
        path: "{{ harbor_installer_dir }}/docker-compose.yml"
        insertafter: '      - "{{ harbor_https_port }}:8443"'
        line: '      - "{{ harbor_http_port }}:8080"'
        state: present
      notify: Reiniciar Harbor Proxy




    # ---------------------
    # 7) Garantir rede ngsoc_net
    # ---------------------
    - name: Garantir rede ngsoc_net
      community.docker.docker_network:
        name: "{{ external_trivy_network }}"
        driver: bridge
        state: present

    # ---------------------
    # 8) Subir stack Harbor
    # ---------------------
    - name: docker compose up -d (Harbor)
      ansible.builtin.shell:
        cmd: docker compose up -d
        chdir: "{{ harbor_compose_dir }}"
      register: up_result
      changed_when: true

    - name: docker compose ps (Harbor)
      ansible.builtin.command: docker compose ps
      args:
        chdir: "{{ harbor_compose_dir }}"
      register: ps_out
      changed_when: false

    # ---------------------
    # 9) Conectar containers Harbor √† rede ngsoc_net
    # ---------------------
    - name: Conectar containers Harbor √† ngsoc_net
      ansible.builtin.shell: |
        for c in harbor-log redis harbor-db registry registryctl harbor-core harbor-jobservice harbor-portal harbor-trivy harbor-proxy; do
          docker network connect {{ external_trivy_network }} "$c" 2>/dev/null || true
        done
      changed_when: false

    # ---------------------
    # 10) README e sa√≠da
    # ---------------------
    - name: Gerar README.txt (docs)
      ansible.builtin.copy:
        dest: "{{ harbor_docs_dir }}/README.txt"
        mode: '0644'
        content: |
          ==========================================================
          NG-SOC - Harbor Registry ({{ harbor_version }})
          ==========================================================
          Web:
            HTTPS: {{ harbor_hostname }}:{{ harbor_https_port }}
            HTTP : {{ harbor_hostname }}:{{ harbor_http_port }}

          Admin:
            user: admin
            pass: {{ harbor_admin_password }}

          Diret√≥rios:
            Installer : {{ harbor_installer_dir }}
            Data      : {{ harbor_data_dir }}
            Logs      : {{ harbor_logs_dir }}

          Notas:
            - Syslog(1514) desativado (port=0).
            - Logs locais em {{ harbor_logs_dir }}.
            - Trivy externo: {{ 'habilitado em ' ~ external_trivy_network if use_external_trivy else 'desabilitado' }}.

    - name: Mostrar docker compose ps
      ansible.builtin.debug:
        var: ps_out.stdout_lines

    - name: Mostrar docker compose ps
      ansible.builtin.debug:
        var: ps_out.stdout_lines

# ===============================
# HANDLERS
# ===============================
  handlers:
    - name: Reiniciar Harbor Jobservice
      ansible.builtin.shell: |
        docker restart harbor-jobservice || true
      listen: Reiniciar Harbor Jobservice

    - name: Reiniciar Harbor Proxy
      ansible.builtin.shell: |
        docker restart nginx || true
      listen: Reiniciar Harbor Proxy
