# /etc/rsyslog.d/containers.conf
# Rsyslog config for container logs -> writes to /var/log/<app>/*.log
# Only load imfile here (do NOT re-load imuxsock or imjournal which are usually loaded globally)

module(load="imfile")        # only imfile module

# Templates -> destination files
template(name="T_HarborCore" type="string" string="/var/log/harbor/core.log")
template(name="T_HarborJob"  type="string" string="/var/log/harbor/jobservice.log")
template(name="T_HarborTrivy" type="string" string="/var/log/harbor/trivy-adapter.log")
template(name="T_HarborProxy" type="string" string="/var/log/harbor/proxy.log")

template(name="T_Metasploit" type="string" string="/var/log/metasploit/framework.log")
template(name="T_Mitmproxy" type="string" string="/var/log/mitmproxy/mitmproxy.log")
template(name="T_ZAP" type="string" string="/var/log/zap/zap.log")

# Routing by programname (created by imfile Tag)
if ($programname == "harbor-core") then {
    action(type="omfile" dynaFile="T_HarborCore")
    stop
}
else if ($programname == "harbor-jobservice") then {
    action(type="omfile" dynaFile="T_HarborJob")
    stop
}
else if ($programname == "harbor-trivy") then {
    action(type="omfile" dynaFile="T_HarborTrivy")
    stop
}
else if ($programname == "harbor-proxy") then {
    action(type="omfile" dynaFile="T_HarborProxy")
    stop
}
else if ($programname == "metasploit") then {
    action(type="omfile" dynaFile="T_Metasploit")
    stop
        }
else if ($programname == "mitmproxy") then {
    action(type="omfile" dynaFile="T_Mitmproxy")
    stop
}
else if ($programname == "zap") then {
    action(type="omfile" dynaFile="T_ZAP")
    stop
}

# NOTE: descartes temporariamente comentados durante validação
# if ($msg contains "health check") or ($msg contains "GET /api/ping") then stop
# if ($msg contains "debug") then stop

# ===== imfile inputs (watching files written by containers to host)
# Keep inputs simple, avoid deprecated params (no 'statefile' here)
input(type="imfile"
      File="/opt/ngsoc-deploy/logs/harbor/core/core.log"
      Tag="harbor-core"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

input(type="imfile"
      File="/opt/ngsoc-deploy/logs/harbor/jobservice/jobservice.log"
      Tag="harbor-jobservice"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

input(type="imfile"
      File="/opt/ngsoc-deploy/logs/harbor/trivy-adapter/trivy.log"
      Tag="harbor-trivy"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

# BEGIN managed mitmproxy imfile (added by admin)
input(type="imfile"
      File="/opt/ngsoc-deploy/data/mitmproxy/mitmproxy.log"
      Tag="mitmproxy"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")
# END managed mitmproxy imfile

# BEGIN managed metasploit imfile (added by admin)
input(type="imfile"
      File="/opt/ngsoc-deploy/logs/metasploit/framework.log"
      Tag="metasploit"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")
# END managed metasploit imfile

# -------------------------------------------------------------------
# BEGIN managed metasploit testsite imfile (safe, independent)
# This watches the testsite access log inside /opt and routes to /var/log
# -------------------------------------------------------------------
input(type="imfile"
      File="/opt/ngsoc-deploy/logs/metasploit/testsite/access.log"
      Tag="metasploit_test"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

# Route messages tagged by imfile (programname == Tag) to destination file
if ($programname == "metasploit_test") then {
    action(type="omfile" file="/var/log/metasploit/testsite/access.log")
    stop
}
# END managed metasploit testsite imfile
# -------------------------------------------------------------------

# BEGIN managed owasp zap imfile (added by admin)
input(type="imfile"
      File="/opt/ngsoc-deploy/data/zap/home/zap.log"
      Tag="zap"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")
# END managed owasp  imfile

# BEGIN managed trivy imfile (added by admin)
input(type="imfile"
      File="/opt/ngsoc-deploy/logs/trivy/trivy-server.log"
      Tag="trivy"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

if $programname == "trivy" then {
    action(type="omfile" file="/var/log/trivy/trivy-server.log")
    stop
}
# END managed trivy imfile

# ===================================================================
# BEGIN managed openvas (greenbone) imfile  [NG-SOC]
# ===================================================================
# Captura os logs do container OpenVAS/GVM (Greenbone)
# e os roteia para /var/log/openvas/openvas.log
# ===================================================================

input(type="imfile"
      File="/opt/ngsoc-deploy/logs/openvas/openvas.log"
      Tag="greenbone"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

# Roteamento mais tolerante (tratando tags/prefixos diferentes)
if ($programname startswith "greenbone" or $syslogtag contains "greenbone") then {
    action(type="omfile" file="/var/log/openvas/openvas.log")
    stop
}

input(type="imfile"
      File="/opt/ngsoc-deploy/logs/openvas/gvm/ospd-openvas.log"
      Tag="greenbone-ospd"
      Severity="info"
      Facility="local6"
      reopenOnTruncate="on")

if ($programname == "greenbone-ospd") then {
    action(type="omfile" file="/var/log/openvas/ospd-openvas.log")
    stop
}
# ===================================================================
# END managed openvas (greenbone) imfile  [NG-SOC]
# ===================================================================
