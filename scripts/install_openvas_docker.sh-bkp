#!/usr/bin/env bash
# install_openvas_docker.sh - Deploy OpenVAS / Greenbone via Ansible (NGSOC)

set -euo pipefail

PLAYBOOK_FILE="/opt/ngsoc-deploy/Ansible/playbooks/deploy_openvas.yml"
NGSOC_DIR="/opt/ngsoc-deploy"

GSA_HOST_PORT="${GSA_HOST_PORT:-9392}"
GSA_ADMIN_USER="${GSA_ADMIN_USER:-admin}"
GSA_ADMIN_PASS="${GSA_ADMIN_PASS:-Ng5ocAdm1n!23}"

echo "=========================================================="
echo "üöÄ IN√çCIO DA INSTALA√á√ÉO DO OPENVAS/GVM (VIA ANSIBLE)"
echo "=========================================================="

if ! command -v ansible-playbook &>/dev/null; then
  echo "‚ùå ERRO: Ansible n√£o encontrado. Instale o Ansible antes de continuar."
  exit 1
fi

if [ ! -f "${PLAYBOOK_FILE}" ]; then
  echo "‚ùå ERRO: Playbook n√£o encontrado em ${PLAYBOOK_FILE}"
  exit 2
fi

ansible-playbook --syntax-check "${PLAYBOOK_FILE}"

ansible-playbook "${PLAYBOOK_FILE}" \
  -i "localhost," \
  --connection=local \
  --extra-vars "gsa_host_port=${GSA_HOST_PORT} gsa_admin_user=${GSA_ADMIN_USER} gsa_admin_pass=${GSA_ADMIN_PASS}"

SERVER_IP=$(hostname -I | awk '{print $1}')

echo "=========================================================="
echo "‚úÖ OPENVAS/GVM DEPLOY CONCLU√çDO COM SUCESSO!"
echo "=========================================================="
echo "üåê Acesse: http://${SERVER_IP}:${GSA_HOST_PORT}/"
echo "üë§ Usu√°rio: ${GSA_ADMIN_USER}"
echo "üîí Senha: ${GSA_ADMIN_PASS}"
echo "üìÑ Leia: ${NGSOC_DIR}/docs/openvas/README.txt"
echo "=========================================================="
