##!/bin/bash
# install_harbor.sh - Vers√£o V3 (Mensagem final formatada e limpa)

# Vari√°veis (Devem refletir as do playbook para a mensagem final)
ANSIBLE_PLAYBOOK="/opt/ngsoc-deploy/Ansible/playbooks/deploy_harbor.yml"
HARBOR_INSTALLER_DIR="/opt/ngsoc-deploy/data/harbor/installer"
HARBOR_DOCS_PATH="/opt/ngsoc-deploy/docs/harbor/README.txt"

# Vari√°veis de Acesso (Devem refletir as do playbook)
HARBOR_HOSTNAME="harbor.local"
HARBOR_HTTPS_PORT="8443"
HARBOR_ADMIN_USER="admin"
HARBOR_ADMIN_PASS="Harbor12345"

echo "=========================================================="
echo "üöÄ IN√çCIO: Instala√ß√£o/Provisionamento do Harbor (Ansible)"
echo "=========================================================="

# 1. Limpeza e Valida√ß√£o Inicial
echo "üßπ Limpando reposit√≥rios Docker antigos..."
rm -f /etc/apt/sources.list.d/docker.list /etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list
rm -f /etc/apt/keyrings/docker.gpg

echo "üîç Validando apt update inicial..."
if ! sudo apt update; then
    echo "üö® FALHA: O comando 'apt update' falhou. Verifique sua conectividade ou reposit√≥rios."
    exit 1
fi

# 2. Execu√ß√£o do Playbook
echo "üîç Verificando sintaxe do Playbook..."
ansible-playbook --syntax-check "$ANSIBLE_PLAYBOOK"

if [ $? -ne 0 ]; then
    echo "üö® FALHA: Sintaxe do Playbook inv√°lida."
    exit 1
fi

echo "üöÄ Executando Playbook..."
ansible-playbook "$ANSIBLE_PLAYBOOK"

# O Ansible pode retornar 0 mesmo com falhas (devido ao ignore_errors).
# Continuamos para a verifica√ß√£o de status real.
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è AVISO: O Playbook do Harbor retornou um c√≥digo de erro. Verificando o status real dos containers..."
fi

# 3. Verifica√ß√£o de Status Final (P√≥s-Playbook)
echo "üîç Verificando o status dos containers do Harbor..."

# Conta o n√∫mero de containers cr√≠ticos (nginx e harbor-core) que est√£o "Up"
# Para esta verifica√ß√£o, usamos 'grep -E' para buscar por ambos, e 'grep -i " Up "' para garantir o status
HARBOR_STATUS=$(cd $HARBOR_INSTALLER_DIR 2>/dev/null && docker compose ps -a | grep -E '(nginx|harbor-core)' | grep -i ' Up ' | wc -l)
EXPECTED_CRITICAL_CONTAINERS=2

if [ "$HARBOR_STATUS" -lt "$EXPECTED_CRITICAL_CONTAINERS" ]; then
    echo "=========================================================="
    echo "üö® FALHA: O Harbor falhou ao subir. Apenas $HARBOR_STATUS de $EXPECTED_CRITICAL_CONTAINERS containers cr√≠ticos (core, nginx) est√£o rodando."
    echo "Para detalhes e troubleshooting, consulte: $HARBOR_DOCS_PATH"
    echo "=========================================================="
    exit 1
fi

# 4. Mensagem de Sucesso e Refer√™ncia √† Documenta√ß√£o (FORMATO LISTA)
echo "=========================================================="
echo "‚úÖ HARBOR DEPLOYMENT CONCLU√çDO COM SUCESSO!"
echo "=========================================================="
echo "Detalhes de Acesso R√°pido:"
echo ""
echo "  üåê Portal Web (HTTPS):"
echo "    - Link: https://${HARBOR_HOSTNAME}:${HARBOR_HTTPS_PORT}"
echo ""
echo "  üîí Credenciais Administrativas:"
echo "    - Usu√°rio: ${HARBOR_ADMIN_USER}"
echo "    - Senha: ${HARBOR_ADMIN_PASS}"
echo ""
echo "  üìÑ Documenta√ß√£o Completa e Comandos (README):"
echo "    - Caminho: ${HARBOR_DOCS_PATH}"
echo "----------------------------------------------------------"
