#!/bin/bash
# install_harbor.sh - Vers√£o Final V4
# Automatiza a instala√ß√£o completa do Harbor NGSOC via Ansible Playbook

ANSIBLE_PLAYBOOK="/opt/ngsoc-deploy/Ansible/playbooks/deploy_harbor.yml"
HARBOR_INSTALLER_DIR="/opt/ngsoc-deploy/data/harbor/installer"
HARBOR_DOCS_PATH="/opt/ngsoc-deploy/docs/harbor/README.txt"

HARBOR_HOSTNAME="harbor.local"
HARBOR_HTTPS_PORT="8443"
HARBOR_ADMIN_USER="admin"
HARBOR_ADMIN_PASS="Harbor12345"

echo "=========================================================="
echo "üöÄ IN√çCIO: Instala√ß√£o/Provisionamento do Harbor (Ansible)"
echo "=========================================================="

# 1. Limpeza inicial
echo "üßπ Limpando reposit√≥rios Docker antigos..."
rm -f /etc/apt/sources.list.d/docker.list /etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list
rm -f /etc/apt/keyrings/docker.gpg

echo "üîç Atualizando pacotes APT..."
sudo apt update -y

# 2. Execu√ß√£o do Playbook
echo "üîç Verificando sintaxe do Playbook..."
ansible-playbook --syntax-check "$ANSIBLE_PLAYBOOK" || { echo "üö® Sintaxe inv√°lida"; exit 1; }

echo "üöÄ Executando Playbook..."
ansible-playbook "$ANSIBLE_PLAYBOOK" || echo "‚ö†Ô∏è Playbook retornou c√≥digo de erro, verificando status..."

# 3. Verifica√ß√£o dos containers cr√≠ticos
echo "üîç Verificando status dos containers cr√≠ticos (nginx, harbor-core)..."
HARBOR_STATUS=$(cd $HARBOR_INSTALLER_DIR 2>/dev/null && docker compose ps -a | grep -E '(nginx|harbor-core)' | grep -i 'Up ' | wc -l)
EXPECTED_CRITICAL_CONTAINERS=2

if [ "$HARBOR_STATUS" -lt "$EXPECTED_CRITICAL_CONTAINERS" ]; then
    echo "üö® FALHA: Apenas $HARBOR_STATUS de $EXPECTED_CRITICAL_CONTAINERS containers cr√≠ticos est√£o rodando."
    echo "Consulte README: $HARBOR_DOCS_PATH"
    exit 1
fi

# 4. Mensagem final de sucesso
echo "=========================================================="
echo "‚úÖ HARBOR DEPLOYMENT CONCLU√çDO COM SUCESSO!"
echo "=========================================================="
echo "Portal Web: https://${HARBOR_HOSTNAME}:${HARBOR_HTTPS_PORT}"
echo "Admin: ${HARBOR_ADMIN_USER} / Senha: ${HARBOR_ADMIN_PASS}"
echo "Documenta√ß√£o: ${HARBOR_DOCS_PATH}"
echo "=========================================================="
