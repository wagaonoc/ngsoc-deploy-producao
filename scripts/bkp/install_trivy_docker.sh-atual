#!/bin/bash
set -e

PLAYBOOK_FILE="/opt/ngsoc-deploy/Ansible/playbooks/deploy_trivy.yml"

echo "=========================================================="
echo "üöÄ IN√çCIO: Instala√ß√£o/Provisionamento do Trivy (Ansible)"
echo "=========================================================="

# Verificar sintaxe do Playbook
echo "üîç Verificando sintaxe do Playbook..."
if ! ansible-playbook "$PLAYBOOK_FILE" --syntax-check; then
    echo "‚ùå ERRO: Sintaxe do Playbook inv√°lida."
    exit 1
fi
echo "‚úÖ Sintaxe do Playbook OK."

# Executar Playbook
echo "‚öôÔ∏è  Executando Playbook..."
if ansible-playbook "$PLAYBOOK_FILE"; then
    echo "=========================================================="
    echo "‚úÖ TRIVY: Playbook executado com sucesso!"
    echo "=========================================================="
    echo "üìå DETALHES COMPLETOS: /opt/ngsoc-deploy/docs/trivy/README.txt"
    echo ""
    echo "üìå Teste de Cliente RPC (exemplo):"
    echo "   docker exec -it ngsoc_trivy sh -c \"TRIVY_SERVER='http://localhost:4954' trivy image alpine:latest\""
    echo "=========================================================="
else
    echo "‚ùå ERRO: Falha na execu√ß√£o do Playbook."
    exit 1
fi
