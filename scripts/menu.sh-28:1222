#!/usr/bin/env bash
set -euo pipefail

SCRIPTS_PATH="/opt/ngsoc-deploy/scripts"
WIDTH=90
HEIGHT=35

# ===============================
# Tela de boas-vindas
# ===============================
show_welcome() {
    # tenta figlet, senão usa texto simples
    NGSOC_ASCII=$(figlet -f big "NGSOC" 2>/dev/null || echo "NGSOC")
    POSITIVOS_ASCII=$(figlet -f small "POSITIVOS+" 2>/dev/null || echo "POSITIVOS+")

    center_text() {
        local line="$1"
        local line_len=${#line}
        local pad=$(( (WIDTH - line_len) / 2 ))
        if [ "$pad" -lt 0 ]; then pad=0; fi
        printf "%*s%s\n" "$pad" "" "$line"
    }

    CENTERED_ASCII=""
    while IFS= read -r l; do
        CENTERED_ASCII+=$(center_text "$l")$'\n'
    done <<< "$NGSOC_ASCII"

    CENTERED_POSITIVOS=""
    while IFS= read -r l; do
        CENTERED_POSITIVOS+=$(center_text "$l")$'\n'
    done <<< "$POSITIVOS_ASCII"

    WELCOME_MSG="Bem-vindo ao NGSOC - OpenSource SOC\nConfigure e gerencie suas ferramentas de monitoramento e pentest."
    CENTERED_MSG=""
    while IFS= read -r l; do
        CENTERED_MSG+=$(center_text "$l")$'\n'
    done <<< "$(echo -e "$WELCOME_MSG")"

    LINE_LARGE=$(printf '=%.0s' $(seq 1 "$WIDTH"))
    LINE_MEDIUM=$(printf -- '-%.0s' $(seq 1 $((WIDTH/2))))
    LINE_SMALL=$(printf -- '.%.0s' $(seq 1 $((WIDTH/4))))

    FOOTER="© 2025 POSITIVOS+. Todos os direitos reservados. Licença: MIT"

    ASCII_ART="${CENTERED_ASCII}${CENTERED_POSITIVOS}${LINE_LARGE}\n${CENTERED_MSG}${LINE_MEDIUM}\n${LINE_SMALL}\n${FOOTER}"

    whiptail --title "NGSOC - Bem-vindo" --msgbox "$ASCII_ART" "$HEIGHT" "$WIDTH" --ok-button "INICIAR"
}

# ===============================
# Menu Principal
# ===============================
main_menu() {
    while true; do
        CHOICE=$(whiptail --title "NGSOC - Menu Principal" --menu "Escolha uma opção" "$HEIGHT" "$WIDTH" 12 \
            "1" "Pré-requisitos" \
            "2" "Implantação" \
            "3" "Gestão" \
            "4" "Portais" \
            "5" "Estrutura de diretórios" \
            "0" "Sair" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1) prerequisites_menu ;;
            2) deployment_menu ;;
            3) gestion_menu ;;
            4) portals_menu ;;
            5) directory_structure ;;
            0) exit 0 ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done
}

# ===============================
# Pré-requisitos
# ===============================
prerequisites_menu() {
    while true; do
        CHOICE=$(whiptail --title "Pré-requisitos" --menu "Escolha uma opção" 22 78 12 \
            "1" "Criar Estrutura de Diretórios" \
            "2" "Criar Estrutura Rsyslog" \
            "3" "Instalar Básicos" \
            "4" "Instalar Docker" \
            "5" "Instalar Ansible" \
            "0" "VOLTAR" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1)
                bash "$SCRIPTS_PATH/create_dirs.sh"
                if [ $? -eq 0 ]; then
                    whiptail --msgbox "✅ Estrutura de diretórios criada e permissionada com sucesso!" 8 60
                else
                    whiptail --msgbox "❌ Erro ao criar estrutura de diretórios. Verifique os logs." 8 60
                fi
                ;;
            2)
                bash "$SCRIPTS_PATH/create_rsyslog_structure.sh"
                if [ $? -eq 0 ]; then
                    whiptail --msgbox "✅ Estrutura Rsyslog criada e arquivos configurados com sucesso!" 8 60
                else
                    whiptail --msgbox "❌ Falha ao criar estrutura Rsyslog. Verifique permissões e logs." 8 60
                fi
                ;;
            3) bash "$SCRIPTS_PATH/install_basics.sh" ;;
            4) bash "$SCRIPTS_PATH/install_docker.sh" ;;
            5) bash "$SCRIPTS_PATH/install_ansible.sh" ;;
            0) break ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done
}

# ===============================
# Implantação
# ===============================
deployment_menu() {
    while true; do
        CHOICE=$(whiptail --title "Implantação" --menu "Escolha um componente para instalar" 20 78 11 \
            "1" "Wazuh" \
            "2" "OpenVAS / GVM" \
            "3" "MITMProxy" \
            "4" "Trivy" \
            "5" "Metasploit" \
            "6" "MongoDB" \
            "7" "Harbor" \
            "8" "OWASP ZAP" \
            "0" "VOLTAR" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1) bash "$SCRIPTS_PATH/install_wazuh_allinone.sh" ;;
            2) bash "$SCRIPTS_PATH/install_openvas_docker.sh" ;;
            3) bash "$SCRIPTS_PATH/install_mitmproxy_docker.sh" ;;
            4) bash "$SCRIPTS_PATH/install_trivy_docker.sh" ;;
            5) bash "$SCRIPTS_PATH/install_metasploit_docker.sh" ;;
            6) bash "$SCRIPTS_PATH/install_mongodb_docker.sh" ;;
            7) bash "$SCRIPTS_PATH/install_harbor_docker.sh" ;;
            8) bash "$SCRIPTS_PATH/install_zap_docker.sh" ;;
            0) break ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done
}

# ===============================
# Gestão
# ===============================
gestion_menu() {
    while true; do
        CHOICE=$(whiptail --title "Gestão" --menu "Escolha uma opção" 20 78 12 \
            "1" "Status Serviços e Containers" \
            "2" "Restart Wazuh" \
            "3" "Restart Containers por Componente" \
            "0" "VOLTAR" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1) show_status ;;
            2) restart_wazuh ;;
            3) restart_containers_menu ;;
            0) break ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done
}

# ===============================
# Status
# ===============================
show_status() {
    local STATUS_TEXT
    STATUS_TEXT=$(mktemp)
    local H=28
    local W=88

    {
        echo "==== WAZUH Services ===="
        for svc in wazuh-manager wazuh-indexer wazuh-dashboard; do
            if systemctl is-active --quiet "${svc}.service" 2>/dev/null; then
                printf "  [%s] ✅ UP\n" "$svc"
            else
                printf "  [%s] ❌ DOWN\n" "$svc"
            fi
        done
        echo ""
    } > "$STATUS_TEXT"

    declare -A TOOLS
    TOOLS["OpenVAS"]="gvm|openvas|greenbone"
    TOOLS["MITMProxy"]="mitmproxy|ngsoc_mitmproxy"
    TOOLS["Trivy"]="trivy|ngsoc_trivy"
    TOOLS["MongoDB"]="mongo|mongodb|msf-db"
    TOOLS["Harbor"]="harbor|registry|harbor-core|harbor-db|harbor-portal|harbor-jobservice|redis"
    TOOLS["OWASP ZAP"]="zap|ngsoc_zap"
    TOOLS["Metasploit"]="metasploit|msf|ngsoc_metasploit"

    DOCKER_LIST=$(docker ps -a --format "{{.Names}}\t{{.Status}}" 2>/dev/null || true)

    for TOOL in OpenVAS MITMProxy Trivy Metasploit MongoDB Harbor "OWASP ZAP"; do
        pattern="${TOOLS[$TOOL]}"
        echo "==== $TOOL Containers ====" >> "$STATUS_TEXT"
        matches=$(printf "%s\n" "$DOCKER_LIST" | grep -E "$pattern" || true)
        if [ -z "$matches" ]; then
            echo "  (nenhum container encontrado para $TOOL)" >> "$STATUS_TEXT"
        else
            while IFS=$'\n' read -r line; do
                name=$(printf "%s" "$line" | cut -f1)
                status=$(printf "%s" "$line" | cut -f2-)
                if [[ "$status" == Up* ]]; then
                    echo "  [$name] ✅ $status" >> "$STATUS_TEXT"
                else
                    echo "  [$name] ❌ $status" >> "$STATUS_TEXT"
                fi
            done <<< "$matches"
        fi
        echo "" >> "$STATUS_TEXT"
    done

    whiptail --title "Status dos Serviços e Containers" --scrolltext --textbox "$STATUS_TEXT" "$H" "$W"
    rm -f "$STATUS_TEXT"
    return 0
}

# ===============================
# Restart Wazuh
# ===============================
restart_wazuh() {
    for svc in wazuh-manager wazuh-indexer wazuh-dashboard; do
        if systemctl list-unit-files --type=service | grep -q "^${svc}.service"; then
            systemctl restart "${svc}.service" || true
        fi
    done
    whiptail --msgbox "Serviços Wazuh reiniciados (se existiam)." 8 50
}

# ===============================
# Restart Containers
# ===============================
restart_containers_menu() {
    local RESTARTED=false
    while true; do
        CHOICE=$(whiptail --title "Restart Containers" --menu "Escolha um componente" 20 78 12 \
            "1" "OpenVAS / GVM" \
            "2" "MITMProxy" \
            "3" "Trivy" \
            "4" "MongoDB" \
            "5" "Harbor" \
            "6" "OWASP ZAP" \
            "7" "Metasploit" \
            "0" "VOLTAR" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "gvm|openvas|greenbone" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container OpenVAS encontrado." 8 60
                fi
                ;;
            2)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "mitmproxy|ngsoc_mitmproxy" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container MITMProxy encontrado." 8 60
                fi
                ;;
            3)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "trivy|ngsoc_trivy" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container Trivy encontrado." 8 60
                fi
                ;;
            4)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "mongo|mongodb|msf-db" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container MongoDB encontrado." 8 60
                fi
                ;;
            5)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "harbor|registry|harbor-core" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container Harbor encontrado." 8 60
                fi
                ;;
            6)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "zap|ngsoc_zap" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container ZAP encontrado." 8 60
                fi
                ;;
            7)
                conts=$(docker ps -a --format '{{.Names}}' | grep -E "metasploit|msf|ngsoc_metasploit" || true)
                if [ -n "$conts" ]; then
                    echo "$conts" | xargs -r docker restart
                    RESTARTED=true
                else
                    whiptail --msgbox "Nenhum container Metasploit encontrado." 8 60
                fi
                ;;
            0) break ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done

    if [ "$RESTARTED" = true ]; then
        whiptail --msgbox "Containers reiniciados!" 8 50
    fi
}

# ===============================
# Portais
# ===============================
portals_menu() {
    while true; do
        CHOICE=$(whiptail --title "Portais" --menu "Escolha um portal" 20 78 10 \
            "1" "OWASP ZAP" \
            "2" "OPENVAS" \
            "3" "MITMProxy" \
            "4" "Wazuh Dashboard" \
            "5" "TRIVY" \
            "6" "Harbor" \
            "0" "VOLTAR" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1) xdg-open "http://192.168.100.23:8080" 2>/dev/null || whiptail --msgbox "URL: http://192.168.100.23:8080" 8 60 ;;
            2) xdg-open "http://192.168.100.23:9392/login" 2>/dev/null || whiptail --msgbox "URL: http://192.168.100.23:9392/login" 8 60 ;;
            3) xdg-open "http://192.168.100.23:8090/#/flows" 2>/dev/null || whiptail --msgbox "URL: http://192.168.100.23:8090/#/flows" 8 60 ;;
            4) xdg-open "https://localhost:443" 2>/dev/null || whiptail --msgbox "URL: https://localhost:443" 8 60 ;;
            5) xdg-open "http://192.168.100.23:4954/" 2>/dev/null || whiptail --msgbox "URL: http://192.168.100.23:4954/" 8 60 ;;
            6) xdg-open "https://harbor.local:8443/" 2>/dev/null || whiptail --msgbox "URL: https://harbor.local:8443/" 8 60 ;;
            0) break ;;
            *) whiptail --msgbox "Opção inválida" 8 40 ;;
        esac
    done
}

# ===============================
# Estrutura de diretórios (visual)
# ===============================
directory_structure() {
    local DIR_TEXT
    DIR_TEXT=$(mktemp)
    cat <<'EOT' > "$DIR_TEXT"
/opt/ngsoc-deploy
├── data
│   ├── harbor
│   ├── mitmproxy
│   ├── trivy
│   ├── trivy-proxy
│   ├── openvas
│   ├── metasploit
│   └── zap
├── docs
│   ├── harbor
│   ├── mitmproxy
│   ├── trivy
│   ├── openvas
│   ├── metasploit
│   └── zap
├── exports
│   ├── harbor
│   ├── mitmproxy
│   ├── trivy
│   ├── openvas
│   ├── metasploit
│   └── zap
├── logs
│   ├── harbor
│   ├── mitmproxy
│   ├── trivy
│   ├── openvas
│   ├── metasploit
│   └── zap
├── reports
│   ├── harbor
│   ├── mitmproxy
│   ├── trivy
│   ├── openvas
│   ├── metasploit
│   └── zap
├── scripts
│   ├── install_ansible.sh
│   ├── install_docker.sh
│   ├── install_harbor_docker.sh
│   ├── install_mitmproxy_docker.sh
│   ├── install_nginx_docker.sh
│   ├── install_openvas_docker.sh
│   ├── install_trivy_docker.sh
│   ├── install_wazuh_allinone.sh
│   ├── install_metasploit_docker.sh
│   ├── install_zap_docker.sh
│   ├── menu.sh
│   └── restart_all_containers.sh
├── ansible
│   ├── playbooks
│      ├── deploy_mitmproxy.yml
│      ├── deploy_openvas.yml
│      ├── deploy_trivy.yml
│      ├── deploy_metasploit.yml
│      ├── deploy_zap.yml
│      ├── deploy_wazuh_allinone.yml
│      ├── deploy_harbor.yml
│      └── deploy_nginx.yml
└── Fim
EOT

    whiptail --title "Estrutura de Diretórios" --scrolltext --textbox "$DIR_TEXT" 25 80
    rm -f "$DIR_TEXT"
}

# ===============================
# Execução
# ===============================
show_welcome
main_menu
