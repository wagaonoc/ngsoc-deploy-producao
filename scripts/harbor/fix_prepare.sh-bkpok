#!/bin/bash
set -euo pipefail
# ===============================================================
# üß∞ RESTAURA√á√ÉO E FIX DO PREPARE DO HARBOR (v2.14.0) ‚Äì FINAL UNIVERSAL REVISADO
# ===============================================================

HARBOR_BASE="/opt/ngsoc-deploy/data/harbor"
INSTALLER_DIR="${HARBOR_BASE}/installer"
INSTALLER_HARBOR_DIR="${INSTALLER_DIR}/harbor"
LOG_DIR="/opt/ngsoc-deploy/logs/harbor"
CERTS_DIR_COMPAT="${HARBOR_BASE}/certs"
REAL_CERT_PATH="/etc/ssl/certs/nginx-selfsigned.crt"
REAL_KEY_PATH="/etc/ssl/private/nginx-selfsigned.key"
SECRET_DIR="${HARBOR_BASE}/data/secret"
KEYS_DIR="${SECRET_DIR}/keys"
TLS_DIR="${SECRET_DIR}/tls"
SECRETKEY_FILE="${KEYS_DIR}/secretkey"
SECRETKEY_VALUE="nsoIfbwfJ9I4NUhz"
PREF_YML="${INSTALLER_HARBOR_DIR}/harbor.yml"
FALLBACK_DIR="${HARBOR_BASE}/prepare_conf"
FALLBACK_YML="${FALLBACK_DIR}/harbor.yml"
GEN_DIR="${HARBOR_BASE}/generated_prepare"
GEN_CONFIG_DIR="${GEN_DIR}/common/config"
PREPARE_IMAGE="goharbor/prepare:v2.14.0"

echo "=============================================================="
echo "üß∞ RESTAURA√á√ÉO E FIX DO PREPARE DO HARBOR (v2.14.0)"
echo "=============================================================="

sudo mkdir -p "${INSTALLER_HARBOR_DIR}" "${LOG_DIR}" "${CERTS_DIR_COMPAT}" \
              "${KEYS_DIR}" "${TLS_DIR}" "${FALLBACK_DIR}" "${GEN_CONFIG_DIR}"

# ---------------------------------------------------------------
# 1Ô∏è‚É£ Certificados e Secretkey
# ---------------------------------------------------------------
echo "1Ô∏è‚É£ Garantindo certificados e segredos..."
sudo cp -n "${REAL_CERT_PATH}" "${CERTS_DIR_COMPAT}/harbor.crt" 2>/dev/null || true
sudo cp -n "${REAL_KEY_PATH}"  "${CERTS_DIR_COMPAT}/harbor.key"  2>/dev/null || true
sudo chmod 600 "${CERTS_DIR_COMPAT}/harbor."*
[[ ! -f "${SECRETKEY_FILE}" || "$(wc -c <"${SECRETKEY_FILE}" | tr -d ' ')" -ne 16 ]] && \
  echo -n "${SECRETKEY_VALUE}" | sudo tee "${SECRETKEY_FILE}" >/dev/null
sudo chmod 600 "${SECRETKEY_FILE}"

# ---------------------------------------------------------------
# 2Ô∏è‚É£ CA Interna
# ---------------------------------------------------------------
echo "2Ô∏è‚É£ Garantindo CA interna..."
if [[ ! -f "${TLS_DIR}/harbor_internal_ca.crt" ]]; then
  sudo openssl req -x509 -newkey rsa:2048 -days 365 -nodes \
    -keyout "${TLS_DIR}/harbor_internal_ca.key" \
    -out "${TLS_DIR}/harbor_internal_ca.crt" \
    -subj "/CN=harbor.local/O=POSITIVOS+/C=BR" >/dev/null 2>&1 || true
  sudo chmod 600 "${TLS_DIR}"/*
fi

# ---------------------------------------------------------------
# 3Ô∏è‚É£ Sele√ß√£o do harbor.yml
# ---------------------------------------------------------------
echo "3Ô∏è‚É£ Selecionando harbor.yml..."
HARBOR_YML="${PREF_YML}"
if [[ ! -f "${HARBOR_YML}" ]]; then
  echo "   ‚ö†Ô∏è ${PREF_YML} n√£o encontrado; criando fallback..."
  sudo mkdir -p "$(dirname "${FALLBACK_YML}")"
  HARBOR_YML="${FALLBACK_YML}"
  sudo tee "${HARBOR_YML}" >/dev/null <<'EOF'
hostname: harbor.local
http:
  port: 8081
https:
  port: 8443
  certificate: /etc/ssl/certs/nginx-selfsigned.crt
  private_key: /etc/ssl/private/nginx-selfsigned.key
harbor_admin_password: "Harbor12345"
database:
  password: "HarborDBpass"
data_volume: /opt/ngsoc-deploy/data/harbor/data
log_location: /opt/ngsoc-deploy/logs/harbor
log:
  level: info
  local:
    location: /opt/ngsoc-deploy/logs/harbor
  syslog:
    port: 0
    protocol: tcp
trivy:
  server_url: http://localhost:4954
  ignore_unfixed: true
  skip_update: false
  vuln_type: "os,library"
  security_check: "vuln"
jobservice:
  max_job_workers: 10
  logger:
    sweeper_duration: 5
    loggers:
      - name: STD_OUTPUT
        level: INFO
      - name: FILE
        level: INFO
        location: /var/log/jobs.log
EOF
fi

# ---------------------------------------------------------------
# 4Ô∏è‚É£ Corrigir jobservice
# ---------------------------------------------------------------
echo "4Ô∏è‚É£ Corrigindo bloco 'jobservice'..."
sudo sed -i '/^jobservice:/,/^$/{
  /^jobservice:/!d
  i\jobservice:\n  max_job_workers: 10\n  logger_sweeper_duration: 1\n  job_loggers:\n    - file\n    - stdout
  d
}' "${HARBOR_YML}"

# ---------------------------------------------------------------
# 5Ô∏è‚É£ Recriar bloco notification no formato esperado
# ---------------------------------------------------------------
echo "5Ô∏è‚É£ Corrigindo bloco 'notification'..."
if grep -q "^notification:" "${HARBOR_YML}"; then
  echo "   üßπ Removendo bloco 'notification:' existente..."
  sudo sed -i '/^notification:/,/^[^[:space:]]/d' "${HARBOR_YML}"
fi

sudo tee -a "${HARBOR_YML}" >/dev/null <<'EOF'

# ============================================================
# Bloco compat√≠vel com prepare v2.14.0
# ============================================================
notification:
  webhook_job_max_retry: 3
  webhook_job_http_client_timeout: 30s
EOF

echo "   üîç Verifica√ß√£o final do bloco 'notification':"
grep -A2 "notification:" "${HARBOR_YML}" || echo "   ‚ö†Ô∏è Bloco n√£o encontrado ‚Äî verifique manualmente."

# ---------------------------------------------------------------
# 6Ô∏è‚É£ Limpeza de res√≠duos de execu√ß√µes anteriores
# ---------------------------------------------------------------
echo "6Ô∏è‚É£ Limpando res√≠duos de execu√ß√µes anteriores..."
sudo docker ps -a --format '{{.ID}} {{.Image}}' | grep 'goharbor/prepare' | awk '{print $1}' | xargs -r sudo docker rm -f >/dev/null 2>&1 || true
sudo rm -rf "${GEN_DIR}"
sudo mkdir -p "${GEN_CONFIG_DIR}"

# ---------------------------------------------------------------
# 7Ô∏è‚É£ Executar prepare
# ---------------------------------------------------------------
echo "7Ô∏è‚É£ Executando prepare (isolado e seguro)..."
WITH_TRIVY="--with-trivy"

sudo docker run --rm \
  -v "${HARBOR_YML}":/input/harbor.yml:ro \
  -v "${HARBOR_BASE}/data":/data \
  -v "${GEN_DIR}":/compose_location \
  -v "${GEN_CONFIG_DIR}":/config \
  -v /:/hostfs:ro \
  -v /etc/ssl/certs:/etc/ssl/certs:ro \
  -v /etc/ssl/private:/etc/ssl/private:ro \
  "${PREPARE_IMAGE}" prepare ${WITH_TRIVY} || {
    echo "‚ùå Falha ao executar prepare."
    exit 1
  }

# ---------------------------------------------------------------
# 8Ô∏è‚É£ Sincroniza√ß√£o segura
# ---------------------------------------------------------------
TS=$(date +%Y%m%d-%H%M%S)
COMPOSE_FILE="${INSTALLER_HARBOR_DIR}/docker-compose.yml"
if [[ -f "${GEN_DIR}/docker-compose.yml" ]]; then
  [[ -f "${COMPOSE_FILE}" ]] && \
    sudo cp -a "${COMPOSE_FILE}" "${COMPOSE_FILE}.bak.${TS}"
  sudo cp -f "${GEN_DIR}/docker-compose.yml" "${COMPOSE_FILE}"
fi
if compgen -G "${GEN_CONFIG_DIR}/*" >/dev/null; then
  rsync -a --delete "${GEN_CONFIG_DIR}/" "${INSTALLER_HARBOR_DIR}/common/config/"
fi

# ---------------------------------------------------------------
# üß© FIX PORTA 1514 ‚Äì Remo√ß√£o para evitar conflito com Wazuh
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß© Removendo mapeamento de porta 1514 (conflito com Wazuh)..."
  sudo sed -i '/1514/d' "${COMPOSE_FILE}"
  sudo sed -i '/10514/d' "${COMPOSE_FILE}"
  echo "   ‚úÖ Portas 1514 e 10514 removidas do docker-compose.yml com sucesso."
  echo "   üßæ Logs continuar√£o sendo gravados em /opt/ngsoc-deploy/logs/harbor"
fi

# ---------------------------------------------------------------
# üß± Neutralizar rsyslog interno (porta 10514)
# ---------------------------------------------------------------
LOG_CONF_FILE="${INSTALLER_HARBOR_DIR}/common/config/log/rsyslog_docker.conf"
LOG_MAIN_FILE="${INSTALLER_HARBOR_DIR}/common/config/log/log.conf"
if [[ -f "${LOG_CONF_FILE}" ]]; then
  sudo sed -i 's/^input(type="imtcp" port="10514")/# desativado: conflito Wazuh/' "${LOG_CONF_FILE}"
fi
if [[ -f "${LOG_MAIN_FILE}" ]]; then
  sudo sed -i '/10514/d' "${LOG_MAIN_FILE}"
fi
echo "   ‚úÖ Porta 10514 desativada no rsyslog interno do Harbor."

# ---------------------------------------------------------------
# üß© Normaliza√ß√£o robusta do servi√ßo 'log' ‚Üí ports: []
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üõ†Ô∏è  Normalizando 'services.log.ports' para array YAML..."
  sudo awk '
    BEGIN{in_log=0; in_hlog=0}
    /^services:/ {print; next}
    /^  log:$/    {in_log=1; print; next}
    /^  harbor-log:$/ {in_hlog=1; print; next}
    (in_log || in_hlog) {
      if ($0 ~ /^    ports:/) { print "____PORTS_PLACEHOLDER____"; next }
      if ($0 ~ /^      - /)   { next }
      if ($0 ~ /^  [a-zA-Z0-9_-]+:/) {
        print "    ports: []"
        in_log=0; in_hlog=0
      }
      print; next
    }
    {print}
  ' "${COMPOSE_FILE}" | sudo tee "${COMPOSE_FILE}.tmp1" >/dev/null
  sudo sed -i 's/^____PORTS_PLACEHOLDER____$/    ports: []/' "${COMPOSE_FILE}.tmp1"
  sudo mv "${COMPOSE_FILE}.tmp1" "${COMPOSE_FILE}"
  echo "   ‚úÖ services.log(.|)ports normalizado."
fi

# ---------------------------------------------------------------
# 9Ô∏è‚É£ Corre√ß√£o estrutural do bloco 'services.log.volumes'
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß± Corrigindo estrutura de volumes do servi√ßo 'log'..."
  TMP_FIX="${COMPOSE_FILE}.tmp_fixlog"

  awk '
    BEGIN {in_log=0; in_vol=0}
    /^  log:$/        {in_log=1; print; next}
    (in_log && /^  [a-zA-Z0-9_-]+:/ && $1=="  " && $2!="log:") {in_log=0}
    {
      if (in_log && /^    volumes:/) {
        print "    volumes:"
        print "      - type: bind"
        print "        source: ./common/config/log/logrotate.conf"
        print "        target: /etc/logrotate.d/logrotate.conf"
        print "      - type: bind"
        print "        source: ./common/config/log/rsyslog_docker.conf"
        print "        target: /etc/rsyslog.d/rsyslog_docker.conf"
        print "      - /opt/ngsoc-deploy/logs/harbor/:/var/log/docker/:z"
        in_vol=1
        next
      }
      if (in_vol && $0 ~ /^    [a-zA-Z]/) {in_vol=0}
      if (!in_vol) print
    }
  ' "${COMPOSE_FILE}" > "${TMP_FIX}"

  sudo mv "${TMP_FIX}" "${COMPOSE_FILE}"
  echo "   ‚úÖ Bloco 'services.log.volumes' reconstru√≠do com sucesso."
fi

# ---------------------------------------------------------------
# üîß Remover duplica√ß√µes de 'ports'
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üßπ Corrigindo duplica√ß√µes de 'ports:' dentro do docker-compose.yml..."
  sudo awk '
    BEGIN {ports_seen=0}
    {
      if ($0 ~ /^    ports:/) {
        if (ports_seen==0) { print; ports_seen=1; next }
        else next
      }
      if ($0 ~ /^  [a-zA-Z0-9_-]+:/) { ports_seen=0 }
      print
    }
  ' "${COMPOSE_FILE}" > "${COMPOSE_FILE}.tmp_cleanports"
  sudo mv "${COMPOSE_FILE}.tmp_cleanports" "${COMPOSE_FILE}"
  echo "   ‚úÖ Duplica√ß√µes de 'ports:' removidas com sucesso."
fi

# ---------------------------------------------------------------
# üß© Corrigir formato 'networks'
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß© Corrigindo formato de 'networks:' nos servi√ßos log/harbor-log..."
  sudo awk '
    BEGIN {in_log=0; in_hlog=0}
    /^  log:$/ {in_log=1; print; next}
    /^  harbor-log:$/ {in_hlog=1; print; next}
    (in_log || in_hlog) {
      if ($0 ~ /^    networks:/) {
        print "    networks:"
        print "      - harbor"
        next
      }
      if ($0 ~ /^  [a-zA-Z0-9_-]+:/) {in_log=0; in_hlog=0}
    }
    {print}
  ' "${COMPOSE_FILE}" > "${COMPOSE_FILE}.tmp_networksfix"
  sudo mv "${COMPOSE_FILE}.tmp_networksfix" "${COMPOSE_FILE}"
  echo "   ‚úÖ Formato de 'networks:' corrigido para array com sucesso."
fi

# ---------------------------------------------------------------
# üß© Recriar blocos cap_drop/cap_add no formato funcional
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß© Recriando blocos cap_drop e cap_add com listas v√°lidas..."
  sudo sed -i '/^    cap_drop:/,/^    cap_add:/c\    cap_drop:\n      - ALL\n    cap_add:\n      - CHOWN\n      - DAC_OVERRIDE\n      - SETGID\n      - SETUID' "${COMPOSE_FILE}"
  echo "   ‚úÖ cap_drop/cap_add reconstru√≠dos no formato de lista (compat√≠vel com Compose)."
fi

# ---------------------------------------------------------------
# üîé Confer√™ncia visual
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "‚Äî‚Äî‚Äî Trecho atual do servi√ßo log/harbor-log ‚Äî‚Äî‚Äî"
  nl -ba "${COMPOSE_FILE}" | sed -n '/^ *[0-9]\+  *  log:$/,/^ *[0-9]\+  *  [a-zA-Z0-9_-]\+:$/p'
  nl -ba "${COMPOSE_FILE}" | sed -n '/^ *[0-9]\+  *  harbor-log:$/,/^ *[0-9]\+  *  [a-zA-Z0-9_-]\+:$/p'
  echo "‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî"
fi

# =================================================================
# üîó (ACR√âSCIMO) Rede padr√£o ngsoc_net ‚Äì sem remover nada anterior
# =================================================================
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üåê Ajustando rede para usar 'ngsoc_net' como rede padr√£o externa (preservando corre√ß√µes)..."

  # 1) Troca refer√™ncias expl√≠citas a "- harbor" por "- default" (os servi√ßos passam a usar a rede default)
  sudo sed -i 's/^\([[:space:]]*\)-[[:space:]]*harbor$/\1- default/' "${COMPOSE_FILE}" || true

  # 2) Remove bloco 'networks:' existente (se houver) para reescrever com default externo
  #    Obs.: remove somente bloco final (n√£o afeta conte√∫dos de servi√ßo)
  awk '
    BEGIN {innet=0}
    /^networks:[[:space:]]*$/ {innet=1; next}
    innet && /^[^[:space:]]/ {innet=0}
    !innet {print}
  ' "${COMPOSE_FILE}" | sudo tee "${COMPOSE_FILE}.tmp_netdefault" >/dev/null
  sudo mv "${COMPOSE_FILE}.tmp_netdefault" "${COMPOSE_FILE}"

  # 3) Acrescenta defini√ß√£o de rede default ‚Üí ngsoc_net (externa)
  sudo tee -a "${COMPOSE_FILE}" >/dev/null <<'EOF'

networks:
  default:
    external: true
    name: ngsoc_net
EOF

  echo "   ‚úÖ Rede default -> ngsoc_net configurada."
fi

# =================================================================
# üóÇÔ∏è (ACR√âSCIMO) Logs via volume (idempotente) ‚Äì sem remover nada
# =================================================================
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üóÇÔ∏è Garantindo exporta√ß√£o de logs via volume para /opt/ngsoc-deploy/logs/harbor (sem 1514)..."

  # Servi√ßo 'log' j√° foi reconstru√≠do com o bind, mas refor√ßamos idempotente:
  sudo awk -v bind="      - /opt/ngsoc-deploy/logs/harbor/:/var/log/docker/:z" '
    BEGIN {inlog=0; inv=0; has=0}
    /^  log:$/ {inlog=1; print; next}
    inlog && /^    volumes:/ {inv=1; print; next}
    inlog && inv && $0 ~ /^[[:space:]]*-[[:space:]]*\/opt\/ngsoc-deploy\/logs\/harbor\/:\/var\/log\/docker\/:z/ {has=1}
    inlog && inv && ($0 ~ /^  [a-zA-Z0-9_-]+:/) { # saiu do bloco do servi√ßo sem achar o bind
      if (!has) print bind
      inlog=0; inv=0; has=0
    }
    {print}
    END {
      # se arquivo terminou ainda dentro de volumes de log
      if (inlog && inv && !has) print bind
    }
  ' "${COMPOSE_FILE}" | sudo tee "${COMPOSE_FILE}.tmp_logbind" >/dev/null
  sudo mv "${COMPOSE_FILE}.tmp_logbind" "${COMPOSE_FILE}"

  echo "   ‚úÖ Bind de logs garantido no servi√ßo 'log'."
fi

# ---------------------------------------------------------------
# üîö Conclus√£o
# ---------------------------------------------------------------
echo "=============================================================="
[[ -f "${INSTALLER_HARBOR_DIR}/docker-compose.yml" ]] \
  && echo "üìÑ docker-compose.yml gerado com sucesso em ${INSTALLER_HARBOR_DIR}/docker-compose.yml" \
  || echo "‚ö†Ô∏è docker-compose.yml n√£o localizado; verifique ${GEN_DIR}"

printf "üìÅ Itens-chave:\n   - %s\n" \
  "${CERTS_DIR_COMPAT}/harbor.key" \
  "${CERTS_DIR_COMPAT}/harbor.crt" \
  "${SECRETKEY_FILE}" \
  "${TLS_DIR}/harbor_internal_ca.crt" \
  "${HARBOR_YML}"

# ---------------------------------------------------------------
# üß© FIX FINAL: corrigir refer√™ncias residuais √† rede 'harbor'
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß© Corrigindo servi√ßos que ainda referenciam a rede 'harbor'..."

  # 1Ô∏è‚É£ Corrige o Formato 2 (chave de configura√ß√£o de rede)
  sudo sed -i 's/^[[:space:]]*harbor:[[:space:]]*$/    default:/' "${COMPOSE_FILE}" || true

  # 2Ô∏è‚É£ Corrige o Formato 1 (lista)
  sudo sed -i 's/^[[:space:]]*-[[:space:]]*harbor$/      - default/' "${COMPOSE_FILE}" || true

  # 3Ô∏è‚É£ Remove bloco networks duplicado
  awk '
    BEGIN {innet=0}
    /^networks:[[:space:]]*$/ {innet=1; next}
    innet && /^[^[:space:]]/ {innet=0}
    !innet {print}
  ' "${COMPOSE_FILE}" | sudo tee "${COMPOSE_FILE}.tmp_harborfix" >/dev/null
  sudo mv "${COMPOSE_FILE}.tmp_harborfix" "${COMPOSE_FILE}"

  # 4Ô∏è‚É£ Garante rede default ‚Üí ngsoc_net
  if ! grep -q "name: ngsoc_net" "${COMPOSE_FILE}"; then
    sudo tee -a "${COMPOSE_FILE}" >/dev/null <<'EOF'

networks:
  default:
    external: true
    name: ngsoc_net
EOF
  fi

  echo "   ‚úÖ Todas as refer√™ncias √† rede 'harbor' foram substitu√≠das por 'ngsoc_net'."
fi

# ---------------------------------------------------------------
# üß© FIX EXTRA: garantir que 'networks:' de todos os servi√ßos use formato de lista
# ---------------------------------------------------------------
if [[ -f "${COMPOSE_FILE}" ]]; then
  echo "üß© Normalizando formato de 'networks:' para lista em todos os servi√ßos..."

  sudo awk '
    BEGIN {in_service=0; in_net=0}
    /^  [a-zA-Z0-9_-]+:$/ {in_service=1; in_net=0; print; next}
    in_service && /^    networks:$/ {in_net=1; print; next}
    in_net && /^      [a-zA-Z0-9_-]+:$/ {
      sub(/^[[:space:]]*[a-zA-Z0-9_-]+:/,"      - default",$0)
      in_net=0
    }
    {print}
  ' "${COMPOSE_FILE}" | sudo tee "${COMPOSE_FILE}.tmp_netarray" >/dev/null
  sudo mv "${COMPOSE_FILE}.tmp_netarray" "${COMPOSE_FILE}"

  echo "   ‚úÖ Todos os servi√ßos usam formato de lista para 'networks:'."
fi

echo "=============================================================="
echo "üéØ FIX-PREPARE FINAL UNIVERSAL ‚Äî CONCLU√çDO."
echo "=============================================================="


echo "=============================================================="
echo "üéØ FIX-PREPARE FINAL UNIVERSAL ‚Äî CONCLU√çDO."
echo "=============================================================="
